## CL-0007 通知ログ改修　他 2026-02-01

### 変更内容

- 通知ログ改修(CL-0006)の実装

- gradle 9.0.0 適用による変更

## CL-0006 アプリ目的の明確化　2026-01-29

### 変更内容

今回はアプリ目的の明確化によるEntity変更による規模の修正の前段階として、設計書及びREADME.md改修のみとする。

### 背景

通知ログ観測結果と、MIUI系OSの通知リスナー権限画面の「危険」表示からでたことによる方針変更として、

**通知ログからタイトルを記録しない**  

とした。それは以下の理由による。  

   1. CL-0005改修によりタイトル無しでTTSできる。
   2. タイトルはプライバシーに関する内容がある。
   3. 副産物として、保存コストの削減が期待できる。

## CL-0005 通知の取り扱いに関する改修 2026-01-24

### 背景

- PackageNameからPackageManagerによるアプリ名取得(label)はどうも時間経過とともに取得できない現象がある。
- それによって、CL-0003の改修を行ったが、そのままでは使えないルールが多発する。

### 改修のポイント

- 通知リスナーサービスでPackageNameで取得できたアプリ名だけを本アプリの処理対象とする。
- アプリ名取得は、通知リスナーで取得したアプリ名を通知ログの項目としてアプリ名(appLabel)を新規追加。
- 今まで、PackageManagerで各所アプリ名変換で使用してきた部分をDBのアプリ名から取得してルールの延命を図る。
- 通知リスナーサービスのアクセス権限を有効にしたくないユーザーに対しては、本アプリの終了を選択できるようにした。
- 設計書に記載の検索タイトル未設定は、そのアプリの通知全体を検索ヒット対象にした、これは設計書の当初の仕様である。
- 音声メッセージ(VoiceMag)がemptyの場合は、<アプリ名>の通知が届きましたという音声読み上げを行うように修正した、
- 以上の改修により、設計書文言、README.mdの文言を修正した。

### その他の改修

- 通知ログ、ルールに採用していた一意制約インデックスをタイトル、通知メッセージの初期値をnullからemptyにした。
- 一意政策インデックスのタイトルについて、重複を避ける付与文字を(n)から-#nnにした。
- ルールのコピーと通理ログによる２系統のルール追加処理を一本化した、

## CL-0004 マナーモード対応、バグ修正 2026-01-23

### マナーモード対応

- マナーモードの場合はTTSを出力しない。

### バグ修正

- 現象  
  ルール内許可スイッチの状態がDB反映されない。したがって通知しても音声案内が出力されない。

- 原因  
  RulesAdapterで、CL-0003対応時に通常バインドを許可スイッチに入れていなかった。

- 対応  
  ViewHolderのbind関数内にバインドするコードを追加

## CL-0003 無効通知の整理 2026-01-22

### 現象

- 追加ボタンクリックによる通知ログ表示で、アプリ名に変換できず、パッケージ名＋デフォルトアイコンのレコードがある。

### 原因

- PackageManager.NameNotFoundException例外が発生するも、パッケージ名とデフォルトアイコンを表示するコードになっていた。
- 以下の点が直接原因と考えられる。
  1. プリインストール系、一時的なメーカーアプリ、disabled / hidden 状態のアプリは、getApplicationInfo(packageName, 0) が 例外を投げる or null相当 になることがある
  2. 表示時点でアンインストール/無効化されて、後から変換が失敗
  3. 別ユーザー（Work profile / サブユーザー）由来の通知
  4. パッケージは見えるがリソース参照が失敗（まれに Resources.NotFoundException 系）

### 対処
- PackageManager.NameNotFoundException例外が発生した場合は、通知ログの該当行削除依頼をNotificationLogAdapterに追加
- NotificationLogAdapter->MainFragment->MainViewModel->NotificationLogRepository->NotificationDaoで該当行を削除
- Ruleに既にある無効なレコードに対してenabledをオフにする処理を追加。アプリ名に無効であることを表示。（削除判断はユーザーに任せる）
- その他クリティカルバグの修正

## CL-0002 プライバシーポリシー変更 - 2026-01-20

### 変更内容
- Google Play Storeのデフォルト言語が`ja-JP`のため、プライバシーポリシーを日本語版リンクに変更。よって下記の修正をした。
  1. 日本語プライバシーポリシーに英語版へのリンクを文末に追加。
  2. 英語版プライバシーポリシーに日本語版へのリンクを文末に追加
- フィーチャーグラフィックを追加


## CL-0001 Internal Test Start - 2026-01-19

### 変更内容
- ソースコード内のクラス・メソッドに KDoc コメントを追加
- 追加ボタンで表示する通知ログリストに✕(閉じる)ボタンを追加。
- 追加ボタンでダブルタップする新しいルールの重複タイトル自動生成をカウントから、50回ループによるナンバリングに変更。
- 同上において、ナンバリングの表示形式を`(n)`から`-#nn`に変更。
- MainViewModel内の日本語出力部分を国際化対応。
  1. MainViewModelにsealed interface AddRuleFromLogEventを追加
  2. MainViewModelでは文言を生成せず、AddRuleFromLogEvent として結果のみを通知（StateFlowを公開）
  3. MainFragmentで購読して、string.xmlによる国際対応メッセージに変換してSnackBarに出力